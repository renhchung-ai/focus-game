<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>匹茲堡睡眠品質指標（PSQI）自評量表</title>
  <style>
    :root { --bg:#0b1020; --card:#121a36; --ink:#e7ecff; --muted:#aab3d9; --accent:#7aa2ff; }
    *{box-sizing:border-box} body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif; background:linear-gradient(180deg,#0b1020,#0e1530 60%,#0b1020); color:var(--ink)}
    .wrap{max-width:980px;margin:48px auto;padding:24px}
    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:24px 22px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:.2em 0 .4em; font-size:clamp(22px,3.6vw,34px); letter-spacing:.5px}
    h2{margin:28px 0 12px; font-size:clamp(18px,2.2vw,22px); color:var(--accent)}
    fieldset{border:none; padding:0; margin:0 0 12px}
    .grid{display:grid; gap:12px}
    @media(min-width:880px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:repeat(3,1fr)} }
    label{display:block; font-weight:600; margin-bottom:6px}
    input[type="number"],select,button,textarea{width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0d1531; color:var(--ink)}
    select option{color:#000}
    .row{display:grid; grid-template-columns:1fr 220px; gap:12px; align-items:center}
    .help{color:var(--muted); font-size:13px}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:2px 10px; border-radius:999px; background:#0e1d4a; color:#cfe0ff; font-size:12px; border:1px solid rgba(122,162,255,.35)}
    .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:18px}
    .kpi{display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); margin-top:14px}
    .kpi .box{background:#0c1738; border:1px solid rgba(255,255,255,.08); padding:14px; border-radius:14px}
    .box h3{font-size:14px; margin:0 0 6px; color:#a6c1ff}
    .lg{font-size:28px; font-weight:800}
    .footer{margin-top:24px; font-size:13px; color:var(--muted)}
    .divider{height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent); margin:18px 0}
    .req{color:#ffb3b3}
    .subq{margin-bottom:10px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>匹茲堡睡眠品質指標（PSQI）自評量表 <span class="pill">1 個月回溯</span></h1>
    <p class="muted">依據 PSQI 計分規則自動計算 7 個構面（A–G）與總分（0–21）。本頁可將作答紀錄送到您指定的後端（例如 Google 試算表／Supabase／Firebase）。</p>

    <form id="psqiForm" class="grid">
      <h2>一、過去一個月的大多數睡眠習慣</h2>
      <!-- Q1-Q4 -->
      <fieldset class="row"><div><label>1. 通常何時上床？ <span class="req">*</span></label><div class="help">用於計算習慣性睡眠效率</div></div><select name="q1_bedtime" id="q1_bedtime" required></select></fieldset>
      <fieldset class="row"><div><label>2. 通常多久入睡（分鐘）？ <span class="req">*</span></label><div class="help">入睡潛伏期（B 構面）</div></div><input type="number" name="q2_latency_min" min="0" required value="10" /></fieldset>
      <fieldset class="row"><div><label>3. 通常幾點起床？ <span class="req">*</span></label><div class="help">用於計算習慣性睡眠效率</div></div><select name="q3_waketime" id="q3_waketime" required></select></fieldset>
      <fieldset class="row"><div><label>4. 每晚實際睡眠時數（小時，含小數） <span class="req">*</span></label><div class="help">睡眠時間（C 構面）</div></div><input type="number" name="q4_sleep_hours" min="0" max="24" step="0.1" required value="6" /></fieldset>

      <h2>二、過去一個月的睡眠經驗</h2>
      <!-- Q5a -->
      <fieldset class="row"><div><label>5a. 您是否因為入睡困難而感到困擾？</label></div><select name="q5a"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></fieldset>

      <!-- Q5b–j -->
      <fieldset>
        <label>5b–5j. 下列狀況是否影響您的睡眠？</label>
        <div class="subq">5b. 半夜或清晨容易醒來 <select name="q5b"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></div>
        <div class="subq">5c. 需要起床上廁所 <select name="q5c"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></div>
        <div class="subq">5d. 因呼吸不適而醒來 <select name="q5d"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></div>
        <div class="subq">5e. 因咳嗽或打鼾而醒來 <select name="q5e"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></div>
        <div class="subq">5f. 感覺太冷 <select name="q5f"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></div>
        <div class="subq">5g. 感覺太熱 <select name="q5g"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></div>
        <div class="subq">5h. 做惡夢 <select name="q5h"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></div>
        <div class="subq">5i. 因疼痛影響睡眠 <select name="q5i"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></div>
        <div class="subq">5j. 其他原因（請註明） <select name="q5j"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select> <input type="text" name="q5j_text" placeholder="請描述其他原因" style="margin-left:8px; padding:6px; width:60%"/></div>
      </fieldset>

      <!-- Q6-Q9 -->
      <fieldset class="row"><div><label>6. 您如何評價整體睡眠品質？</label></div><select name="q6_quality"><option value="0">很好</option><option value="1">尚可</option><option value="2">差</option><option value="3">很差</option></select></fieldset>
      <fieldset class="row"><div><label>7. 您是否使用安眠藥物？</label></div><select name="q7_med"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></fieldset>
      <fieldset class="row"><div><label>8. 白天有因睡眠不足影響做事？</label></div><select name="q8_day_sleepy"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></fieldset>
      <fieldset class="row"><div><label>9. 白天缺乏精力去做事？</label></div><select name="q9_energy"><option value="0">無</option><option value="1">每週少於1次</option><option value="2">每週1–2次</option><option value="3">每週3次以上</option></select></fieldset>

      <div class="legal">本網站所提供之計算結果為學術上之推估，僅供參考，並非專業醫療判斷，請勿以本網站之測量結果作為任何醫療決策之基礎，您於本網站所提供的資訊，將做為學術研究參考用。若您同意以上聲明，請按立即計分繼續。</div>
<div class="actions">
  
      <div class="actions">
        <button type="button" id="btnComputeSubmit" onclick="computeAndSubmit()">立即計分</button>
        <button type="button" onclick="psqiForm.reset(); resetOutput(); setDefaults();">清除重填</button>
      </div>
    </form>

    <div id="result" class="kpi"></div>

    <div id="conn" class="muted" style="margin-top:8px"></div>

    <div class="footer">
      <div class="divider"></div>
      <p>計分邏輯依據 PSQI 標準：七個構面（A–G）各 0–3 分，總分 0–21；常見臨床切點為總分 &gt; 5 代表睡眠品質較差。此頁僅供教學／研究使用，僅供參考。</p>
    </div>
  </div>
</div>

<script>
  // === 修正：Q1/Q3 下拉改由腳本初始化，並在 DOMContentLoaded 後執行 ===
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbwQdaIyVhTt3hIY2YdNOazduxU1-pqE-FFmPK0IPa2U56Ulr6KXEkSM7e5mk1-3Z3Kk1Q/exec"; // 例："https://script.google.com/macros/s/XXXX/exec?key=YOUR_TOKEN" // ← 填上您的 API 端點（留空則僅本機計分，不送出）

  function populateTimeSelect(selId, defaultVal){
    const sel = document.getElementById(selId);
    if(!sel) return;
    sel.innerHTML = '<option value="">選擇時間</option>';
    for(let h=0; h<24; h++){
      for(let q=0; q<4; q++){
        const hh = String(h).padStart(2,'0');
        const mm = String(q*15).padStart(2,'0');
        const v = `${hh}:${mm}`;
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      }
    }
    if(defaultVal){ sel.value = defaultVal; }
  }

  function setDefaults(){
    populateTimeSelect('q1_bedtime', '22:30');
    populateTimeSelect('q3_waketime', '06:30');
    const lat = document.querySelector('[name="q2_latency_min"]');
    const hrs = document.querySelector('[name="q4_sleep_hours"]');
    if(lat) lat.value = 10;
    if(hrs) hrs.value = 6;
  }

  document.addEventListener('DOMContentLoaded', setDefaults);

  // === 計分邏輯 ===
  function hmsToMinutes(t){ if(!t) return 0; const [hh,mm] = t.split(":").map(Number); return hh*60 + mm; }
  function componentB(latencyMin, q5a){ let latScore = latencyMin <= 15 ? 0 : latencyMin <= 30 ? 1 : latencyMin <= 60 ? 2 : 3; const sum = latScore + q5a; return sum === 0 ? 0 : (sum <= 2 ? 1 : (sum <= 4 ? 2 : 3)); }
  function componentC(hours){ return hours > 7 ? 0 : hours >= 6 ? 1 : hours >= 5 ? 2 : 3; }
  function componentD(bedMin, wakeMin, sleepHours){ let tibMin = wakeMin - bedMin; if(tibMin <= 0) tibMin += 24*60; const tibHours = tibMin/60; const eff = (sleepHours / Math.max(tibHours, 0.01)) * 100; const score = eff > 85 ? 0 : eff >= 75 ? 1 : eff >= 65 ? 2 : 3; return { score, tibHours, eff }; }
  function componentE(sum5bTo5j){ return sum5bTo5j === 0 ? 0 : (sum5bTo5j <= 9 ? 1 : (sum5bTo5j <= 18 ? 2 : 3)); }
  function componentG(q8, q9){ const s = q8 + q9; return s === 0 ? 0 : (s <= 2 ? 1 : (s <= 4 ? 2 : 3)); }

  function getInt(name){ const el = document.querySelector(`[name="${name}"]`); return el ? (parseInt(el.value,10) || 0) : 0; }
  function getNum(name){ const el = document.querySelector(`[name="${name}"]`); return el ? (parseFloat(el.value) || 0) : 0; }
  function getTime(name){ const el = document.querySelector(`[name="${name}"]`); return el ? el.value : ''; }

  function scoreBadge(s){ return `<div class=lg>${s}</div>`; }
  function card(title, body){ return `<div class="box"><h3>${title}</h3>${body}</div>`; }
  function resetOutput(){ const res = document.getElementById('result'); if(res) res.innerHTML = ''; }

  function compute(){
    const bed = getTime('q1_bedtime');
    const wake = getTime('q3_waketime');
    const bedMin = hmsToMinutes(bed);
    const wakeMin = hmsToMinutes(wake);
    const latency = getNum('q2_latency_min');
    const sleepH = getNum('q4_sleep_hours');

    const q5a = getInt('q5a');
    const sum5bTo5j = ['q5b','q5c','q5d','q5e','q5f','q5g','q5h','q5i','q5j'].reduce((s,k)=>s+getInt(k),0);

    const A = getInt('q6_quality');
    const B = componentB(latency, q5a);
    const C = componentC(sleepH);
    const Dobj = componentD(bedMin, wakeMin, sleepH); const D = Dobj.score;
    const E = componentE(sum5bTo5j);
    const F = getInt('q7_med');
    const G = componentG(getInt('q8_day_sleepy'), getInt('q9_energy'));

    const total = A+B+C+D+E+F+G;

    const res = document.getElementById('result');
    if(res){
      res.innerHTML = ''+
        card('總分', `<div class="lg">${total}</div><div class="muted">臨床常用切點：> 5 代表睡眠品質較差</div>`)+
        card('A 主觀睡眠品質', scoreBadge(A))+
        card('B 入睡潛伏期', scoreBadge(B)+`<div class="muted">入睡 ${latency} 分鐘；5a=${q5a}</div>`)+
        card('C 睡眠時間', scoreBadge(C)+`<div class="muted">實睡 ${sleepH} 小時</div>`)+
        card('D 習慣性睡眠效率', scoreBadge(D)+`<div class="muted">效率 ${Dobj.eff.toFixed(1)}%；床上 ${Dobj.tibHours.toFixed(2)} 小時</div>`)+
        card('E 睡眠障礙', scoreBadge(E)+`<div class="muted">5b–5j 合計 ${sum5bTo5j}</div>`)+
        card('F 催眠藥物', scoreBadge(F))+
        card('G 日間功能障礙', scoreBadge(G));
    }

    return {A,B,C,D,E,F,G,total, tibHours:Dobj.tibHours, efficiency:Dobj.eff};
  }

  async function computeAndSubmit(){
    const btn = document.getElementById('btnComputeSubmit');
    const conn = document.getElementById('conn');
    if(btn){ btn.disabled = true; btn.textContent = '計分中…'; }
    const scores = compute();

    const form = document.getElementById('psqiForm');
    const payload = Object.fromEntries(new FormData(form).entries());
    payload.__scores = scores;
    payload.__timestamp = new Date().toISOString();

    if(!ENDPOINT_URL){
      if(conn) conn.textContent = '未設定 ENDPOINT_URL，僅做本機計分（不送出）。';
      alert('已完成本機計分。若要儲存資料，請在原始碼中設定 ENDPOINT_URL。');
      if(btn){ btn.disabled = false; btn.textContent = '立即計分'; }
      return;
    }
    try{
      // 不自訂 headers，避免 CORS preflight（Apps Script 無 doOptions）
      const r = await fetch(ENDPOINT_URL, { method: 'POST', body: JSON.stringify(payload) });
      if(conn) conn.textContent = '已送出到 ' + ENDPOINT_URL;
      if(!r.ok) throw new Error('HTTP '+r.status);
      await r.json().catch(()=>({}));
      if(btn){ btn.textContent = '已送出！'; setTimeout(()=>{ btn.disabled = false; btn.textContent = '立即計分'; }, 1200); }
    }catch(err){
      if(btn){ btn.disabled = false; btn.textContent = '立即計分'; }
    }
  }
</script>
</body>
</html>
